<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Air City - Real-time Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@latest/dist/browser/signalr.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
      }
      h1 {
        color: white;
        text-align: center;
        margin-bottom: 30px;
        font-size: 2.5em;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }
      .status {
        background: white;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .status.connected {
        background: #10b981;
        color: white;
      }
      .status.disconnected {
        background: #ef4444;
        color: white;
      }
      .dashboard {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
      }
      .card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s;
      }
      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 12px rgba(0, 0, 0, 0.2);
      }
      .card h3 {
        color: #667eea;
        margin-bottom: 15px;
        font-size: 1.2em;
      }
      .metric {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #e5e7eb;
      }
      .metric:last-child {
        border-bottom: none;
      }
      .metric-label {
        color: #6b7280;
        font-weight: 500;
      }
      .metric-value {
        font-weight: bold;
        color: #1f2937;
      }
      .aqi-value {
        font-size: 3em;
        text-align: center;
        font-weight: bold;
        margin: 20px 0;
      }
      .aqi-good {
        color: #10b981;
      }
      .aqi-moderate {
        color: #f59e0b;
      }
      .aqi-unhealthy {
        color: #ef4444;
      }
      .timestamp {
        text-align: center;
        color: #6b7280;
        font-size: 0.9em;
        margin-top: 10px;
      }
      .raw-data {
        background: #1f2937;
        color: #10b981;
        padding: 15px;
        border-radius: 10px;
        font-family: "Courier New", monospace;
        font-size: 0.85em;
        max-height: 400px;
        overflow-y: auto;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üåç Smart Air City - Real-time Dashboard</h1>

      <div id="status" class="status disconnected">
        ‚è≥ Connecting to SignalR...
      </div>

      <div class="dashboard">
        <!-- AQI Card -->
        <div class="card">
          <h3>üìä Air Quality Index (AQI)</h3>
          <div id="aqi" class="aqi-value aqi-good">--</div>
          <div class="timestamp" id="timestamp">Waiting for data...</div>
        </div>

        <!-- IoT Sensor Card -->
        <div class="card">
          <h3>üî¨ IoT Sensor (MQ135)</h3>
          <div class="metric">
            <span class="metric-label">Sensor ID:</span>
            <span class="metric-value" id="sensorId">--</span>
          </div>
          <div class="metric">
            <span class="metric-label">Location:</span>
            <span class="metric-value" id="location">--</span>
          </div>
          <div class="metric">
            <span class="metric-label">AQI Value:</span>
            <span class="metric-value" id="iotAqi">--</span>
          </div>
        </div>

        <!-- OpenAQ Data Card -->
        <div class="card">
          <h3>üåê OpenAQ Pollutants</h3>
          <div class="metric">
            <span class="metric-label">PM2.5:</span>
            <span class="metric-value" id="pm25">--</span>
          </div>
          <div class="metric">
            <span class="metric-label">PM10:</span>
            <span class="metric-value" id="pm10">--</span>
          </div>
          <div class="metric">
            <span class="metric-label">O3:</span>
            <span class="metric-value" id="o3">--</span>
          </div>
          <div class="metric">
            <span class="metric-label">NO2:</span>
            <span class="metric-value" id="no2">--</span>
          </div>
          <div class="metric">
            <span class="metric-label">SO2:</span>
            <span class="metric-value" id="so2">--</span>
          </div>
          <div class="metric">
            <span class="metric-label">CO:</span>
            <span class="metric-value" id="co">--</span>
          </div>
        </div>

        <!-- Raw Data Card -->
        <div class="card" style="grid-column: 1 / -1">
          <h3>üìÑ Raw JSON Data</h3>
          <div id="rawData" class="raw-data">Waiting for data...</div>
        </div>
      </div>
    </div>

    <script>
      // SignalR Connection
      const connection = new signalR.HubConnectionBuilder()
        .withUrl("http://localhost:51762/airqualityhub")
        .withAutomaticReconnect()
        .configureLogging(signalR.LogLevel.Debug)
        .build();

      // Update status
      const statusDiv = document.getElementById("status");

      connection.onreconnecting(() => {
        statusDiv.className = "status disconnected";
        statusDiv.textContent = "‚ö†Ô∏è Reconnecting...";
      });

      connection.onreconnected(() => {
        statusDiv.className = "status connected";
        statusDiv.textContent = "‚úÖ Connected to SignalR Hub";
      });

      connection.onclose(() => {
        statusDiv.className = "status disconnected";
        statusDiv.textContent = "‚ùå Disconnected from SignalR Hub";
      });

      // ‚úÖ FIX: ƒê·ªïi t·ª´ "ReceiveAirQualityUpdate" sang "NewAirQualityData"
      connection.on("NewAirQualityData", (data) => {
        console.log("üì© Received data:", data);
        updateDashboard(data);
      });

      // Start connection
      connection
        .start()
        .then(() => {
          statusDiv.className = "status connected";
          statusDiv.textContent = "‚úÖ Connected to SignalR Hub";
          console.log("‚úÖ SignalR Connected!");
        })
        .catch((err) => {
          statusDiv.className = "status disconnected";
          statusDiv.textContent = "‚ùå Connection Failed: " + err;
          console.error("‚ùå SignalR Error:", err);
        });

      // Update dashboard with new data
      function updateDashboard(data) {
        // AQI
        const aqiValue = data.airQualityIndex?.value || 0;
        const aqiDiv = document.getElementById("aqi");
        aqiDiv.textContent = Math.round(aqiValue);

        // AQI color coding
        if (aqiValue <= 50) {
          aqiDiv.className = "aqi-value aqi-good";
        } else if (aqiValue <= 100) {
          aqiDiv.className = "aqi-value aqi-moderate";
        } else {
          aqiDiv.className = "aqi-value aqi-unhealthy";
        }

        // Timestamp
        const timestamp = data.dateObserved?.value || new Date().toISOString();
        document.getElementById("timestamp").textContent = new Date(
          timestamp
        ).toLocaleString("vi-VN");

        // IoT Sensor
        document.getElementById("sensorId").textContent =
          data["sosa:madeBySensor"] || "--";

        const coords = data.location?.value?.coordinates || [];
        document.getElementById("location").textContent = coords.length
          ? `${coords[1]}, ${coords[0]}`
          : "--";

        document.getElementById("iotAqi").textContent = Math.round(aqiValue);

        // OpenAQ Pollutants
        document.getElementById("pm25").textContent =
          data.pm25?.value?.toFixed(2) + " ¬µg/m¬≥" || "--";
        document.getElementById("pm10").textContent =
          data.pm10?.value?.toFixed(2) + " ¬µg/m¬≥" || "--";
        document.getElementById("o3").textContent =
          data.o3?.value?.toFixed(2) + " ¬µg/m¬≥" || "--";
        document.getElementById("no2").textContent =
          data.no2?.value?.toFixed(2) + " ¬µg/m¬≥" || "--";
        document.getElementById("so2").textContent =
          data.so2?.value?.toFixed(2) + " ¬µg/m¬≥" || "--";
        document.getElementById("co").textContent =
          data.co?.value?.toFixed(2) + " ¬µg/m¬≥" || "--";

        // Raw Data
        document.getElementById("rawData").textContent = JSON.stringify(
          data,
          null,
          2
        );
      }
    </script>
  </body>
</html>
